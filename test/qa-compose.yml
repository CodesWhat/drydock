services:
  drydock:
    image: drydock:dev
    container_name: drydock-qa
    user: root
    ports:
      - "3333:3000"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    environment:
      - DD_RUN_AS_ROOT=true
      - DD_LOG_FORMAT=text
      - DD_WATCHER_LOCAL_WATCHBYDEFAULT=false
      - DD_WATCHER_LOCAL_CRON=*/2 * * * *
      # Docker trigger (manual only — auto=false prevents auto-updating test containers)
      - DD_TRIGGER_DOCKER_LOCAL_AUTO=false
      - DD_TRIGGER_DOCKER_LOCAL_PRUNE=true
      - DD_TRIGGER_HTTP_MYWEBHOOK_URL=http://httpbin.org/post
      - DD_TRIGGER_HTTP_MYWEBHOOK_METHOD=POST
      - DD_AUTH_BASIC_ADMIN_USER=admin
      - "DD_AUTH_BASIC_ADMIN_HASH={SHA}W6ph5Mm5Pz8GgiULbPgzG37mj9g="
      - DD_SERVER_WEBHOOK_ENABLED=true
      - DD_SERVER_WEBHOOK_TOKEN=test-token-12345
      - DD_SESSION_SECRET=qa-test-session-secret
      # --- Slack trigger ---
      - DD_TRIGGER_SLACK_MYSLACK_TOKEN=xoxb-fake-slack-token-for-testing
      - DD_TRIGGER_SLACK_MYSLACK_CHANNEL=C01FAKECHANNEL
      # --- SMTP trigger ---
      - DD_TRIGGER_SMTP_MYEMAIL_HOST=smtp.example.com
      - DD_TRIGGER_SMTP_MYEMAIL_PORT=587
      - DD_TRIGGER_SMTP_MYEMAIL_USER=alerts@example.com
      - DD_TRIGGER_SMTP_MYEMAIL_PASS=fakesmtppassword
      - DD_TRIGGER_SMTP_MYEMAIL_FROM=alerts@example.com
      - DD_TRIGGER_SMTP_MYEMAIL_TO=admin@example.com
      # --- GHCR registry (authenticated) ---
      - DD_REGISTRY_GHCR_PRIVATE_USERNAME=myghuser
      - DD_REGISTRY_GHCR_PRIVATE_TOKEN=ghp_fakeGitHubTokenForTesting123
      # --- Gitea registry (self-hosted with custom CA) ---
      - DD_REGISTRY_GITEA_PRIVATE_URL=https://gitea.internal.example
      - DD_REGISTRY_GITEA_PRIVATE_LOGIN=gitea-bot
      - DD_REGISTRY_GITEA_PRIVATE_PASSWORD=replace-me
      - DD_REGISTRY_GITEA_PRIVATE_CAFILE=/certs/internal-ca.pem
      # --- Update Guard (security scanning) ---
      - DD_SECURITY_SCANNER=trivy
      - DD_SECURITY_BLOCK_SEVERITY=CRITICAL
      - DD_SECURITY_SBOM_ENABLED=true
      - DD_SECURITY_SBOM_FORMATS=spdx-json,cyclonedx-json
      # --- Maintenance window (QA) ---
      # Uncomment to test; adjust cron to match/not-match current time
      # - DD_WATCHER_LOCAL_MAINTENANCE_WINDOW=0 2-6 * * *
      # - DD_WATCHER_LOCAL_MAINTENANCE_WINDOW_TZ=UTC
      # --- Remote Docker watcher (DinD) ---
      - DD_WATCHER_REMOTE_HOST=docker-remote
      - DD_WATCHER_REMOTE_PORT=2375
      - DD_WATCHER_REMOTE_WATCHBYDEFAULT=true
      - DD_WATCHER_REMOTE_CRON=*/2 * * * *
      - DD_WATCHER_REMOTE_WATCHEVENTS=true
    depends_on:
      docker-remote:
        condition: service_healthy

  # ── Remote Docker host (DinD) ────────────────────────
  docker-remote:
    image: docker:27-dind
    privileged: true
    environment:
      - DOCKER_TLS_CERTDIR=
    expose:
      - "2375"
    healthcheck:
      test: ["CMD", "docker", "info"]
      interval: 5s
      timeout: 3s
      retries: 10
      start_period: 10s

  # Test containers running on the remote Docker host
  remote-bootstrap:
    image: docker:27
    depends_on:
      docker-remote:
        condition: service_healthy
    environment:
      - DOCKER_HOST=tcp://docker-remote:2375
    entrypoint: ["sh", "-c"]
    command:
      - |
        docker pull nginx:1.24.0
        docker run -d --name remote-nginx --label dd.watch=true --label "dd.display.name=Remote Nginx" --label dd.group=remote nginx:1.24.0
        docker pull redis:7.0.0
        docker run -d --name remote-redis --label dd.watch=true --label "dd.display.name=Remote Redis" --label dd.group=remote redis:7.0.0

  # ── Containers with updates available ──────────────────

  # Nginx with lifecycle hooks (tests hooks UI + group view)
  nginx-hooked:
    image: nginx:1.25.5
    pull_policy: never
    container_name: nginx-hooked
    labels:
      - dd.watch=true
      - dd.display.name=Nginx (Hooked)
      - dd.group=web-stack
      - dd.hook.pre=echo "pre-update check"
      - dd.hook.post=echo "post-update cleanup"
      - dd.hook.timeout=30000

  # Redis in same group (tests group view)
  redis-cache:
    image: redis:7.2.0
    pull_policy: never
    container_name: redis-cache
    labels:
      - dd.watch=true
      - dd.display.name=Redis Cache
      - dd.group=web-stack

  # Traefik with auto-rollback (tests rollback UI)
  traefik-proxy:
    image: traefik:v3.0.0
    pull_policy: never
    container_name: traefik-proxy
    labels:
      - dd.watch=true
      - dd.display.name=Traefik Proxy
      - dd.group=infra
      - dd.rollback.auto=true
      - dd.rollback.window=120000
      - dd.rollback.interval=5000

  # LSCR/GHCR public image (tests anonymous token exchange)
  lscr-nginx:
    image: ghcr.io/linuxserver/nginx:1.26.2
    pull_policy: never
    container_name: lscr-nginx
    labels:
      - dd.watch=true
      - dd.display.name=LSCR Nginx (GHCR)
      - dd.tag.include=^\d+\.\d+\.\d+$$

  # PostgreSQL ungrouped (tests ungrouped container)
  postgres-db:
    image: postgres:16.0
    pull_policy: never
    container_name: postgres-db
    environment:
      - POSTGRES_PASSWORD=testpass
    labels:
      - dd.watch=true
      - dd.display.name=PostgreSQL

  # Mongo — old version with update (tests another registry + more data)
  mongo-db:
    image: mongo:7.0.0
    pull_policy: never
    container_name: mongo-db
    labels:
      - dd.watch=true
      - dd.display.name=MongoDB
      - dd.group=data

  # ── Container at latest (no update available) ─────────

  # Alpine at latest — shows "up to date" state
  alpine-latest:
    image: alpine:latest
    pull_policy: always
    container_name: alpine-latest
    command: ["sleep", "infinity"]
    labels:
      - dd.watch=true
      - dd.display.name=Alpine (Latest)
      - dd.tag.include=^latest$$

  # ── Log spammer (generates container log activity) ─────

  # Busybox printing a line every 5s — populates dashboard container log
  log-spammer:
    image: busybox:1.36
    pull_policy: never
    container_name: log-spammer
    command: ["sh", "-c", "i=0; while true; do i=$((i+1)); echo \"[$$i] drydock-qa heartbeat $(date -u +%H:%M:%S)\"; sleep 5; done"]
    labels:
      - dd.watch=true
      - dd.display.name=Log Spammer
      - dd.group=infra

  # ── Stopped container (tests stopped status badge) ─────

  # Memcached — starts then exits (shows "stopped" in container list)
  memcached-stopped:
    image: memcached:1.6.0
    pull_policy: never
    container_name: memcached-stopped
    command: ["sh", "-c", "exit 0"]
    labels:
      - dd.watch=true
      - dd.display.name=Memcached (Stopped)
