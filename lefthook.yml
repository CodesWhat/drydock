---
# Lefthook configuration — mirrors CI pipeline for local/CI parity.
# pre-push is piped (sequential, fail-fast) so failures surface clearly.
# Each step matches a CI job exactly — if lefthook passes, CI passes.

pre-commit:
  commands:
    format:
      glob: '*.{ts,js,json,vue,css}'
      run: qlty fmt --no-progress {staged_files} && git add {staged_files}

pre-push:
  piped: true
  commands:
    # ── Lint: mirrors CI "Lint" job (qlty check --all from root) ──
    qlty:
      run: CI=1 qlty check --all --no-progress
      priority: 1

    # ── Build: mirrors CI "Build" job ─────────────────────────────
    build-app:
      root: app/
      run: npm run build
      priority: 2
    build-ui:
      root: ui/
      run: npm run build
      priority: 3

    # ── Test: mirrors CI "Test & Coverage" job ────────────────────
    test-app:
      root: app/
      run: npm test
      priority: 4
    test-ui:
      root: ui/
      run: npm run test:unit
      priority: 5

    # ── E2E: mirrors CI "E2E Tests" job ───────────────────────────
    e2e:
      run: ./scripts/run-e2e-tests.sh
      priority: 6

    # ── Advisory: mirrors CI advisory jobs (non-blocking) ─────────
    zizmor:
      glob: '.github/workflows/*.yml'
      run: zizmor .github/workflows/ || true
      skip:
        - run: '! command -v zizmor >/dev/null 2>&1'
      priority: 7

    # ── Local security gates (not in CI, skip if tool missing) ────
    snyk-deps:
      root: app/
      run: ../scripts/snyk-deps-gate.sh --org=codeswhat
      skip:
        - run: '! command -v snyk >/dev/null 2>&1'
      priority: 8
    snyk-code:
      run: scripts/snyk-code-gate.sh --org=codeswhat
      skip:
        - run: '! command -v snyk >/dev/null 2>&1'
      priority: 9
