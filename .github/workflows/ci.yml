name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_call:
    secrets:
      CODECOV_TOKEN:
        required: false

permissions:
  contents: read

jobs:
  zizmor:
    name: Actions Security
    runs-on: ubuntu-latest
    continue-on-error: true  # advisory — GitHub API rate limits cause intermittent 403
    permissions:
      contents: read
      security-events: write
      actions: read

    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@5ef0c079ce82195b2a36a210272d6b661572d83e  # v2.14.2
        with:
          egress-policy: audit

      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd  # v6.0.2
        with:
          persist-credentials: false

      - name: Run zizmor
        uses: zizmorcore/zizmor-action@0dce2577a4760a2749d8cfb7a84b7d5585ebcb7d  # v0.5.0
        with:
          token: ${{ github.token }}

  supply-chain:
    name: Supply Chain Security
    runs-on: ubuntu-latest
    continue-on-error: true  # advisory — Socket API can fail transiently
    permissions:
      contents: read

    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@5ef0c079ce82195b2a36a210272d6b661572d83e  # v2.14.2
        with:
          egress-policy: audit

      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd  # v6.0.2
        with:
          persist-credentials: false

      - name: Setup Socket Firewall
        uses: SocketDev/action@4337a545deecc20f19a909e52db7a2f6ba292f42  # v1.2.0
        with:
          mode: firewall-free
          firewall-version: '1.5.4'

      - name: Scan app dependencies
        run: sfw npm ci
        working-directory: app

      - name: Scan e2e dependencies
        run: sfw npm ci
        working-directory: e2e

      - name: Scan ui dependencies
        run: sfw npm ci
        working-directory: ui

  lint:
    name: Lint
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@5ef0c079ce82195b2a36a210272d6b661572d83e  # v2.14.2
        with:
          egress-policy: audit

      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd  # v6.0.2
        with:
          persist-credentials: false

      - name: Setup Qlty
        uses: qltysh/qlty-action/install@a19242102d17e497f437d7466aa01b528537e899  # v2.2.0

      - name: Qlty check (all plugins)
        run: qlty check --all --no-progress

  test:
    name: Test & Coverage
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@5ef0c079ce82195b2a36a210272d6b661572d83e  # v2.14.2
        with:
          egress-policy: audit

      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd  # v6.0.2
        with:
          persist-credentials: false

      - name: Setup Node.js
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238  # v6.2.0
        with:
          node-version: 24
          cache: 'npm'
          cache-dependency-path: |
            app/package-lock.json
            ui/package-lock.json

      - name: Install app dependencies
        run: npm ci
        working-directory: app

      - name: Install ui dependencies
        run: npm ci
        working-directory: ui

      - name: Run app tests
        run: npm test
        working-directory: app

      - name: Run ui tests
        run: npm run test:unit
        working-directory: ui

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@671740ac38dd9b0130fbe1cec585b89eea48d3de  # v5.5.2
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: app/coverage/lcov.info,ui/coverage/lcov.info
          flags: app,ui
          fail_ci_if_error: true

  build:
    name: Build
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@5ef0c079ce82195b2a36a210272d6b661572d83e  # v2.14.2
        with:
          egress-policy: audit

      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd  # v6.0.2
        with:
          persist-credentials: false

      - name: Setup Node.js
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238  # v6.2.0
        with:
          node-version: 24
          cache: 'npm'
          cache-dependency-path: ui/package-lock.json

      - name: Install ui dependencies
        run: npm ci
        working-directory: ui

      - name: Build ui
        run: npm run build
        working-directory: ui

      - name: Build Storybook (regression smoke)
        run: npm run test:storybook
        working-directory: ui

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@8d2750c68a42422c14e847fe6c8ac0403b4cbd6f  # v3.12.0

      - name: Docker build (smoke test)
        uses: docker/build-push-action@10e90e3645eae34f1e60eeb005ba3a3d33f178e8  # v6.19.2
        with:
          context: .
          push: false
          build-args: DD_VERSION=ci
          cache-from: type=gha
          cache-to: type=gha,mode=max

  e2e:
    name: E2E Tests
    runs-on: ubuntu-latest
    needs: [build]
    permissions:
      contents: read

    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@5ef0c079ce82195b2a36a210272d6b661572d83e  # v2.14.2
        with:
          egress-policy: audit

      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd  # v6.0.2
        with:
          persist-credentials: false

      - name: Setup Node.js
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238  # v6.2.0
        with:
          node-version: 24
          cache: 'npm'
          cache-dependency-path: e2e/package-lock.json

      - name: Install e2e dependencies
        run: npm ci
        working-directory: e2e

      - name: Setup test containers
        run: ./scripts/setup-test-containers.sh

      - name: Start drydock
        id: drydock
        run: ./scripts/start-drydock.sh

      - name: Run Cucumber e2e tests
        run: npm run cucumber
        working-directory: e2e
        env:
          DD_PORT: ${{ steps.drydock.outputs.dd_port }}

      - name: Show drydock logs on failure
        if: failure()
        run: docker logs drydock

      - name: Cleanup
        if: always()
        run: ./scripts/cleanup-test-containers.sh
